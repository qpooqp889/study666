<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KTV 滾動歌詞版</title>
  <style>
    :root {
      --bg: #0b0b12;
      --fg: #eaeaf0;
      --accent: #4ea1ff;
      --accent-2: #9ad1ff;
      --muted: #9aa0a6;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; background: radial-gradient(1200px 700px at 70% -10%, #182544 0%, #0b0b12 60%); color: var(--fg); }

    header { padding: 16px 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); position: sticky; top: 0; z-index: 10; }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; letter-spacing: .5px; opacity: .9; }

    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .controls label { font-size: 12px; color: var(--muted); }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 999px; }
    input[type="file"] { color: var(--fg); }
    input[type="range"] { accent-color: var(--accent); }
    button { cursor: pointer; padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--fg); }
    button:hover { background: rgba(255,255,255,.12); }

    main { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 20px; max-width: 1100px; margin: 0 auto; }

    .stage { position: relative; height: 60vh; border-radius: 24px; overflow: hidden; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.08); box-shadow: 0 10px 40px rgba(0,0,0,.35) inset; display: flex; justify-content: center; align-items: center; padding: 24px; }

    /* 霓虹動態背景 */
    .bg-pulse { position: absolute; inset: -20%; filter: blur(60px); opacity: .45; background:
      radial-gradient(600px 300px at 70% 30%, rgba(78,161,255,.35), transparent),
      radial-gradient(700px 340px at 30% 70%, rgba(154,209,255,.25), transparent),
      radial-gradient(500px 500px at 50% 50%, rgba(120,150,255,.15), transparent);
      animation: float 12s ease-in-out infinite alternate; }
    @keyframes float { from { transform: translateY(-2%); } to { transform: translateY(2%); } }

    /* 歌詞滾動區 */
    .lyrics-scroll { position: relative; width: 100%; max-width: 900px; height: 100%; overflow-y: auto; scroll-behavior: smooth; text-align: center; padding: 20px 10px; }
    .lyrics-scroll::-webkit-scrollbar { width: 6px; }
    .lyrics-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 3px; }

    .line { font-size: clamp(22px, 3.6vw, 40px); font-weight: 600; letter-spacing: .02em; margin: 12px 0; opacity: .55; cursor: pointer; transition: opacity .3s, transform .3s; }
    .line.active { opacity: 1; color: var(--fg); transform: scale(1.1); }
    .line:hover { opacity: .9; }

    /* KTV 漸進填色 */
    .ktv-fill { position: relative; color: #ffffff; }
    .ktv-fill::before { content: attr(data-text); position: absolute; inset: 0; white-space: pre-wrap; overflow: hidden; background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; background-clip: text; color: transparent; width: var(--progress, 0%); display: inline-block; }

    .timeline { width: 100%; height: 6px; background: rgba(255,255,255,.12); border-radius: 999px; overflow: hidden; }
    .timeline > div { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    details { margin-top: 8px; }
    textarea { width: 100%; min-height: 160px; background: rgba(255,255,255,.06); color: var(--fg); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 12px; }

    .helper { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>🎤 KTV 滾動歌詞版</h1>
    <div class="controls">
      <span class="pill"><label>音訊：</label><input id="file-audio" type="file" accept="audio/*" /></span>
      <span class="pill"><label>LRC：</label><input id="file-lrc" type="file" accept=".lrc,.txt" /></span>
      <span class="pill"><label for="offset">校正(ms)</label><input id="offset" type="range" min="-1500" max="1500" value="0" step="10" /><span id="offsetVal" class="helper">0</span></span>
      <button id="btnSample">載入示例歌詞</button>
      <button id="btnPlay">播放 / 暫停</button>
    </div>
  </header>

  <main>
    <section class="stage">
      <div class="bg-pulse" aria-hidden="true"></div>
      <div id="lyricsScroll" class="lyrics-scroll"></div>
    </section>

    <div class="timeline" aria-hidden="true"><div id="tlProgress"></div></div>

    <section>
      <details>
        <summary>顯示 / 編輯 LRC</summary>
        <textarea id="lrcText"></textarea>
        <div class="helper">支援格式：[mm:ss.xx]歌詞文字；可多個時間戳指向同一行。</div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap: wrap;">
          <button id="btnApplyLrc">套用上方 LRC</button>
          <button id="btnClear">清空歌詞</button>
        </div>
      </details>
    </section>

    <audio id="player" preload="metadata" controls style="width:100%; margin-top: 6px;"></audio>
  </main>

  <script>
    const player = document.getElementById('player');
    const fileAudio = document.getElementById('file-audio');
    const fileLrc = document.getElementById('file-lrc');
    const lrcText = document.getElementById('lrcText');
    const lyricsScroll = document.getElementById('lyricsScroll');
    const tlProgress = document.getElementById('tlProgress');
    const offsetRange = document.getElementById('offset');
    const offsetVal = document.getElementById('offsetVal');
    const btnPlay = document.getElementById('btnPlay');

    let lyrics = []; // [{time:number, text:string}]
    let rafId = null;
    let timeOffsetMs = 0;
    let activeIndex = -1;

    function parseLRC(text) {
      const lines = text.split(/\r?\n/);
      const entries = [];
      for (const raw of lines) {
        if (!raw.trim()) continue;
        if (/^\s*\[(ti|ar|al|by|offset):/i.test(raw)) continue;
        const tags = [...raw.matchAll(/\[(\d{1,2}):(\d{1,2})(?:[\.:](\d{1,3}))?\]/g)];
        const textPart = raw.replace(/^(?:\s*\[[^\]]+\])+\s*/, '');
        for (const m of tags) {
          const min = parseInt(m[1], 10) || 0;
          const sec = parseInt(m[2], 10) || 0;
          const frac = m[3] ? parseInt(m[3].padEnd(3, '0').slice(0,3), 10) : 0;
          const t = min * 60 + sec + frac / 1000;
          entries.push({ time: t, text: textPart });
        }
      }
      entries.sort((a,b) => a.time - b.time);
      return entries;
    }

    function renderLyrics() {
      lyricsScroll.innerHTML = '';
      lyrics.forEach((line, idx) => {
        const div = document.createElement('div');
        div.className = 'line';
        const span = document.createElement('span');
        span.className = 'ktv-fill';
        span.dataset.text = line.text;
        span.textContent = line.text;
        div.appendChild(span);
        div.addEventListener('click', () => {
          player.currentTime = line.time;
        });
        lyricsScroll.appendChild(div);
      });
    }

    function setLyrics(newLyrics) {
      lyrics = newLyrics || [];
      renderLyrics();
      activeIndex = -1;
    }

    function findActiveIndex(t) {
      let lo = 0, hi = lyrics.length - 1, ans = -1;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        if (lyrics[mid].time <= t) { ans = mid; lo = mid + 1; }
        else { hi = mid - 1; }
      }
      return ans;
    }

   function updateVisual() {
  const duration = player.duration || 0;
  const baseTime = player.currentTime + timeOffsetMs / 1000;
  if (duration > 0) {
    tlProgress.style.width = `${(baseTime / duration) * 100}%`;
  }

  if (lyrics.length) {
    const i = findActiveIndex(baseTime);

    if (i !== activeIndex) {
      // 移除舊的 active 樣式
      const prevEl = lyricsScroll.children[activeIndex];
      if (prevEl) prevEl.classList.remove('active');

      // 新的 active 行
      const currEl = lyricsScroll.children[i];
      if (currEl) {
        currEl.classList.add('active');

        // 🎯 計算要捲到的目標位置
        const container = lyricsScroll;
        const target =
          currEl.offsetTop - container.clientHeight / 2 + currEl.clientHeight / 2;

        // 平滑動畫
        const start = container.scrollTop;
        const distance = target - start;
        const durationMs = 500; // 動畫時長 (ms)
        let startTime = null;

        function animateScroll(timestamp) {
          if (!startTime) startTime = timestamp;
          const progress = Math.min((timestamp - startTime) / durationMs, 1);
          // easing (easeInOutQuad)
          const eased =
            progress < 0.5
              ? 2 * progress * progress
              : -1 + (4 - 2 * progress) * progress;
          container.scrollTop = start + distance * eased;
          if (progress < 1) requestAnimationFrame(animateScroll);
        }
        requestAnimationFrame(animateScroll);
      }

      activeIndex = i;
    }

    // 填色進度
    const cur = lyrics[i];
    const next = lyrics[i + 1];
    const fillEl = lyricsScroll.children[i]?.querySelector('.ktv-fill');
    if (fillEl && cur) {
      const start = cur.time;
      const end = next ? next.time : (duration || start + 2);
      let r = 0;
      if (baseTime >= start) {
        r = Math.min(
          1,
          Math.max(0, (baseTime - start) / Math.max(0.01, end - start))
        );
      }
      fillEl.style.setProperty('--progress', (r * 100).toFixed(2) + '%');
    }
  }

  rafId = requestAnimationFrame(updateVisual);
}


    function stopRAF() { if (rafId) cancelAnimationFrame(rafId); rafId = null; }

    // File handlers
    fileAudio.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      player.src = url;
      player.play().catch(()=>{});
    });

    fileLrc.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const txt = await f.text();
      lrcText.value = txt;
      setLyrics(parseLRC(txt));
    });

    document.getElementById('btnApplyLrc').addEventListener('click', () => {
      setLyrics(parseLRC(lrcText.value));
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      lrcText.value = '';
      setLyrics([]);
    });

    document.getElementById('btnSample').addEventListener('click', () => {
      const sample = `
[00:05.00]這是 KTV 滾動歌詞 Demo
[00:09.00]請於上方載入你的 MP3 與 LRC
[00:12.50]或直接在此貼上 LRC 並套用
[00:16.00]拖曳校正滑桿可微調對位
[00:19.50]祝你玩得開心！`;
      lrcText.value = sample.trim();
      setLyrics(parseLRC(lrcText.value));
    });

    // Offset
    offsetRange.addEventListener('input', () => {
      timeOffsetMs = parseInt(offsetRange.value, 10) || 0;
      offsetVal.textContent = timeOffsetMs + 'ms';
    });
    offsetVal.textContent = '0ms';

    // Play/Pause button
    btnPlay.addEventListener('click', () => {
      if (player.paused) player.play(); else player.pause();
    });

    // RAF lifecycle
    player.addEventListener('play', () => { stopRAF(); updateVisual(); });
    player.addEventListener('pause', () => stopRAF());
  </script>
</body>
</html>
