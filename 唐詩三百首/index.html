<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>唐詩四選一遊戲（含難度選擇與金幣）</title>
<style>
  html,body {
    margin: 0; padding: 0; height: 100%; background: #fff8e7;
    font-family: "Noto Serif TC", serif;
  }
  #topBar {
    position: fixed; top: 30; left: 0; width: 100%; height: 56px;
    background: #ffe3c5;
    display: flex; align-items: center; justify-content: center;

    gap: 20px;
    box-shadow: 0 2px 6px rgba(179,93,46,0.2);
    user-select:none;
    z-index: 1002;
  }
  #coins {
    position: fixed; left: 12px; top: 12px;
    background: #fff;
    padding: 8px 14px;
    border-radius: 20px;
    box-shadow: 0 3px 8px rgba(179,93,46,0.3);
    font-weight: 900;
    color: #b35d2e;
    z-index: 1003;
    pointer-events: none;
  }
  #score {
    position: fixed; right: 12px; top: 12px;
    background: #fff;
    padding: 8px 14px;
    border-radius: 20px;
    box-shadow: 0 3px 8px rgba(179,93,46,0.3);
    font-weight: 900;
    color: #663300;
    z-index: 1003;
    pointer-events: none;
  }
  label {
    font-weight: 700;
    font-size: 18px;
    color: #b35d2e;
  }
  select {
    font-size: 18px;
    padding: 6px 12px;
    border-radius: 8px;
    border: 2px solid #b35d2e;
    color: #b35d2e;
    cursor: pointer;
    font-weight: 700;
    user-select:none;
  }
  #startBtn {
    background: linear-gradient(135deg, #ff9a76, #ff5722);
    border: none;
    color: white;
    font-size: 20px;
    font-weight: 900;
    padding: 10px 28px;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 5px 12px rgba(255,87,34,0.5);
    transition: background-color 0.3s ease;
    user-select:none;
  }
  #startBtn:active {
    background: linear-gradient(135deg, #ff784e, #e64a19);
  }
  #startBtn:disabled {
    background: #ccc;
    cursor: not-allowed;
    box-shadow: none;
  }
  #gameArea {
    margin-top: 56px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
    padding: 80px 0px 16px 30px;
    min-height: calc(100vh - 56px);
    box-sizing: border-box;
    background: linear-gradient(to bottom, #fff8d0, #ffd580);
    text-align: center;
  }
  #poemTitle {
    font-size: 38px;
    font-weight: 900;
    color: #b35d2e;
    margin-bottom: 8px;
    user-select: none;
  }
  #poemAuthor {
    font-size: 26px;
    color: #6a3f1a;
    margin-bottom: 28px;
    user-select: none;
  }
  #typedChars {
    font-size: 38px;
    font-weight: 900;
    color: #994422;
    min-height: 56px;
    letter-spacing: 8px;
    user-select: none;
    padding: 0 14px;
    word-break: break-word;
    margin-bottom: 32px;
  }
  #optionsContainer {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
  }
  .charOption {
    width: 28vw;
    max-width: 140px;
    height: 120px;
    background: linear-gradient(135deg, #ff9a76, #ff5722);
    border-radius: 20px;
    box-shadow: 0 6px 12px rgba(255, 87, 34, 0.45);
    font-size: 72px;
    font-weight: 900;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 3px solid transparent;
    user-select: none;
    transition: background-color 0.3s ease, transform 0.15s ease;
  }
  .charOption:active {
    transform: scale(0.95);
    background: linear-gradient(135deg, #ff784e, #e64a19);
  }
  .charOption.wrong {
    background: #ffb3b3 !important;
    color: #b30000 !important;
    border-color: #b30000 !important;
  }
  #toast {
    position: fixed;
    left: 50%;
    bottom: 130px;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 16px;
    display: none;
    z-index: 1004;
    user-select:none;
  }
  @media (max-width:420px){
    #poemTitle { font-size: 32px; }
    #poemAuthor { font-size: 22px; }
    #typedChars { font-size: 28px; letter-spacing: 6px; }
    .charOption { height: 100px; font-size: 60px; max-width: 120px; width: 30vw; }
  }
</style>
</head>
<body>
<div id="topBar">
  <label for="difficultySelect">難度選擇:</label>
  <select id="difficultySelect">
    <option value="easy">簡單</option>
    <option value="medium" selected>中等</option>
    <option value="hard">困難</option>
  </select>
  <button id="startBtn">開始遊戲</button>
</div>
<div id="coins">金幣: 0</div>
<div id="score">分數: 0</div>



<div id="gameArea">
  <div id="poemTitle"></div>
  <div id="poemAuthor"></div>
  <div id="typedChars"></div>
  <div id="optionsContainer"></div>
</div>

<div id="toast"></div>

<script>
/* 詩詞分級資料 (示例含少量，請補足50首分級) */
const poems = {
  easy: [
    { title: "靜夜思", author: "李白", text: "床前明月光，疑是地上霜。舉頭望明月，低頭思故鄉。" },
    { title: "春曉", author: "孟浩然", text: "春眠不覺曉，處處聞啼鳥。夜來風雨聲，花落知多少。" },
    { title: "相思", author: "王維", text: "紅豆生南國，春來發幾枝。願君多采擷，此物最相思。" }
  ],
  medium: [
    { title: "登鸛雀樓", author: "王之渙", text: "白日依山盡，黃河入海流。欲窮千里目，更上一層樓。" },
    { title: "送元二使安西", author: "王維", text: "渭城朝雨浥輕塵，客舍青青柳色新。勸君更盡一杯酒，西出陽關無故人。" },
    { title: "春夜喜雨", author: "杜甫", text: "好雨知時節，當春乃發生。隨風潛入夜，潤物細無聲。" }
  ],
  hard: [
    { title: "琵琶行", author: "白居易", text: "大弦嘈嘈如急雨，小弦切切如私語。嘈嘈切切錯雜彈，大珠小珠落玉盤。" },
    { title: "長恨歌", author: "白居易", text: "漢皇重色思傾國，御宇多年求不得。楊家有女初長成，養在深閨人未識。" },
    { title: "醉翁亭記", author: "歐陽修", text: "環滁皆山也。其西南諸峰，林壑尤美，望之蔚然而深秀者，琅琊也。" }
  ]
};

/* DOM */
const coinsEl = document.getElementById('coins');
const scoreEl = document.getElementById('score');
const startBtn = document.getElementById('startBtn');
const difficultySelect = document.getElementById('difficultySelect');
const poemTitle = document.getElementById('poemTitle');
const poemAuthor = document.getElementById('poemAuthor');
const typedChars = document.getElementById('typedChars');
const optionsContainer = document.getElementById('optionsContainer');
const toast = document.getElementById('toast');

let currentPoem = null;
let currentCharIndex = 0;
let score = 0;
let gameRunning = false;

/* localStorage coins */
function loadCoins(){
  const v = localStorage.getItem('coins');
  const n = v ? parseInt(v,10) : 0;
  return Number.isNaN(n) ? 0 : n;
}
function saveCoins(n){
  localStorage.setItem('coins', String(n));
}
let coins = loadCoins();
function updateCoinsDisplay(){
  coinsEl.textContent = `金幣: ${coins}`;
}

/* 初始化 coins */
updateCoinsDisplay();

/* helpers */
function showToast(msg, ms=1400){
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, ms);
}
function getValidChars(text){
  return [...text].filter(c => c !== '，' && c !== '。');
}
const allCharsPool = Object.values(poems).flatMap(arr => arr.map(p => getValidChars(p.text)).flat());
function getRandomDistractors(correctChar, count=3){
  const distractors = [];
  while(distractors.length < count){
    const c = allCharsPool[Math.floor(Math.random()*allCharsPool.length)];
    if(c !== correctChar && !distractors.includes(c)) distractors.push(c);
  }
  return distractors;
}

function speakChar(char){
  const u = new SpeechSynthesisUtterance(char);
  u.lang = 'zh-TW';
  speechSynthesis.speak(u);
}

function updatePoemInfo(){
  if(!currentPoem){ 
    poemTitle.textContent = ''; 
    poemAuthor.textContent = ''; 
    return; 
  }
  poemTitle.textContent = currentPoem.title;
  poemAuthor.textContent = currentPoem.author;
}
function updateTypedChars(){
  if(!currentPoem) return;
  typedChars.textContent = currentPoem.text.slice(0, currentCharIndex);
}

function generateOptions(){
  if(!gameRunning || !currentPoem) return;

  let pos = currentCharIndex;
  while(pos < currentPoem.text.length && (currentPoem.text[pos] === '，' || currentPoem.text[pos] === '。')) pos++;
  if(pos >= currentPoem.text.length){
    awardCoinsAndEnd();
    return;
  }
  const correctChar = currentPoem.text.charAt(pos);
  currentCharIndex = pos;

  const distractors = getRandomDistractors(correctChar, 3);
  const options = [...distractors, correctChar].sort(() => Math.random() - 0.5);

  optionsContainer.innerHTML = '';
  options.forEach(c => {
    const d = document.createElement('div');
    d.className = 'charOption';
    d.textContent = c;
    d.addEventListener('click', () => {
      if(!gameRunning) return;
      if(c === correctChar){
        score++;
        scoreEl.textContent = `分數: ${score}`;
        speakChar(c);

        currentCharIndex++;
        while(currentCharIndex < currentPoem.text.length && (currentPoem.text[currentCharIndex] === '，' || currentPoem.text[currentCharIndex] === '。')){
          currentCharIndex++;
        }
        updateTypedChars();
        generateOptions();
      } else {
        d.classList.add('wrong');
        setTimeout(() => { d.classList.remove('wrong'); }, 350);
      }
    });
    optionsContainer.appendChild(d);
  });
}

function awardCoinsAndEnd(){
  coins += 20;
  saveCoins(coins);
  updateCoinsDisplay();
  showToast('+20 金幣', 1400);

  poemTitle.textContent = `完成：「${currentPoem.title}」 +20 金幣`;
  poemAuthor.textContent = currentPoem.author;
  optionsContainer.innerHTML = '';
  gameRunning = false;
  startBtn.disabled = false;
}

function startGame(){
  if(gameRunning) return;
  score = 0;
  scoreEl.textContent = `分數: ${score}`;

  const diff = difficultySelect.value;
  const pool = poems[diff];
  currentPoem = pool[Math.floor(Math.random() * pool.length)];

  currentCharIndex = 0;
  gameRunning = true;
  startBtn.disabled = true;

  updatePoemInfo();
  updateTypedChars();
  generateOptions();
}

startBtn.addEventListener('click', startGame);

/* 初始化 localStorage coins */
if(localStorage.getItem('coins') === null){
  saveCoins(coins);
}
updateCoinsDisplay();

</script>
</body>
</html>
