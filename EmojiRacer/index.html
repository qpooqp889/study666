<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Emoji è³½è»Šå­¸è‹±æ–‡</title>
  <meta name="viewport" content="width=389, user-scalable=no">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.8.6/nipplejs.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #ffe9f0;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
    }
    #game {
      width: 389px;
      height: 844px;
      margin: auto;
      position: relative;
      background: #fff9f9;
      border: 4px solid #fca3cc;
      border-radius: 20px;
      overflow: hidden;
    }
    #billboard {
      text-align: center;
      background: #ffcae1;
      padding: 10px;
      font-size: 22px;
      border-bottom: 2px dashed #fff;
    }
    #billboard .ch {
      font-weight: bold;
      font-size: 24px;
    }
    #billboard .en {
      font-size: 18px;
      color: #555;
    }
    #energy {
      position: absolute;
      bottom: 200px; /* èª¿æ•´ä½ç½®ï¼Œä¸èˆ‡æ–æ¡¿é‡ç–Š */
      width: 100%;
      text-align: center;
      font-size: 18px;
    }
    #score { /* æ–°å¢è¨ˆåˆ†æ¨£å¼ */
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 20px;
      color: #333;
    }
    #car {
      position: absolute;
      left: 160px;
      top: 600px; /* ç¨å¾®å¾€ä¸‹ç§»ï¼Œè®“æ²¹æ¡¶æœ‰æ›´å¤šç©ºé–“æ‰è½ */
      font-size: 48px;
      transition: top 0.05s, left 0.05s;
    }
    .oil {
      position: absolute;
      font-size: 32px;
      text-align: center;
      opacity: 1;
      transition: opacity 1s ease-out;
    }
    #joystickZone {
      position: absolute;
      bottom: 50px;
      width: 100%;
      height: 150px;
    }
    #startBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff61a6;
      color: white;
      padding: 10px 20px;
      border: none;
      font-size: 20px;
      border-radius: 20px;
      cursor: pointer; /* æ·»åŠ æ»‘é¼ æŒ‡é‡æ¨£å¼ */
    }
    #gameOverScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
      display: none; /* é è¨­éš±è— */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 32px;
      text-align: center;
      z-index: 10000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    }
    #gameOverScreen button {
      background: #ff61a6;
      color: white;
      padding: 10px 20px;
      border: none;
      font-size: 24px;
      border-radius: 20px;
      cursor: pointer;
      margin-top: 20px;
    }
    #resultMsg { /* çµæœè¨Šæ¯æ¨£å¼ */
      position:absolute;
      top:40%;
      left:50%;
      transform: translate(-50%, -50%);
      font-size: 64px;
      font-weight: bold;
      color: green;
      display:none;
      z-index:9999;
      user-select:none;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="score">Score: 0</div> <!-- è¨ˆåˆ†é¡¯ç¤º -->
    <div id="billboard">
      <div class="ch">è˜‹æœ</div>
      <div class="en">Apple</div>
    </div>
    <div id="resultMsg"></div> <!-- çµæœè¨Šæ¯é¡¯ç¤º -->
    <div id="energy">Energy: ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹</div>
    <div id="car">ğŸš—</div>
    <div id="joystickZone"></div>
    <button id="startBtn" onclick="startGame()">â–¶ï¸ é–‹å§‹éŠæˆ²</button>

    <div id="gameOverScreen"> <!-- éŠæˆ²çµæŸç•«é¢ -->
      <h2>éŠæˆ²çµæŸï¼</h2>
      <p id="finalScore">ä½ çš„åˆ†æ•¸ï¼š0</p>
      <button onclick="startGame()">é‡æ–°é–‹å§‹</button>
    </div>
  </div>

  <script>
    // å–å¾— HTML å…ƒç´ 
    const car = document.getElementById('car');
    const billboard = document.getElementById('billboard');
    const energyEl = document.getElementById('energy');
    const game = document.getElementById('game');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScoreEl = document.getElementById('finalScore');
    const scoreEl = document.getElementById('score');

    // éŠæˆ²ç›¸é—œè®Šæ•¸
    const wordList = [
      { ch: "è˜‹æœ", en: "Apple" },
      { ch: "å¤ªé™½", en: "Sun" },
      { ch: "æ›¸", en: "Book" },
      { ch: "ç‹—", en: "Dog" },
      { ch: "æ±½è»Š", en: "Car" },
      { ch: "æœˆäº®", en: "Moon" },
      { ch: "é¦™è•‰", en: "Banana" },
      { ch: "è²“", en: "Cat" },
      { ch: "é›»è…¦", en: "Computer" },
      { ch: "é­š", en: "Fish" }
    ];

    let currentWord;
    let energy = 5;
    let carX = 160;
    let carY = 600;
    let oilTimer, energyTimer, difficultyTimer;
    let isPlaying = false;
    let oils = [];
    let score = 0;
    let oilDropInterval = 3000; // åˆå§‹æ²¹æ¡¶ç”Ÿæˆé–“éš”
    let oilDropSpeed = 4; // åˆå§‹æ²¹æ¡¶æ‰è½é€Ÿåº¦
    const resultMsg = document.getElementById('resultMsg');

    // é¡¯ç¤ºçµæœè¨Šæ¯
    function showResultMsg(text, color) {
      resultMsg.textContent = text;
      resultMsg.style.color = color;
      resultMsg.style.display = 'block';
      setTimeout(() => {
        resultMsg.style.display = 'none';
      }, 1500); // é¡¯ç¤º 1.5 ç§’
    }

    // æ›´æ–°èƒ½é‡é¡¯ç¤º
    function updateEnergy() {
      energyEl.textContent = "Energy: " + "ğŸ”‹".repeat(energy);
      if (energy <= 0) {
        endGame();
      }
    }

    // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
    function updateScore() {
      scoreEl.textContent = `Score: ${score}`;
    }

    // ç”¢ç”Ÿæ–°çš„é¡Œç›®
    function nextQuestion() {
      currentWord = wordList[Math.floor(Math.random() * wordList.length)];
      billboard.querySelector('.ch').textContent = currentWord.ch;
      billboard.querySelector('.en').textContent = currentWord.en;
    }

    // æª¢æŸ¥ç¢°æ’ (ä½¿ç”¨ Bounding Rectangles)
    function checkCollision(car, oil) {
      const carRect = car.getBoundingClientRect();
      const oilRect = oil.getBoundingClientRect();

      return !(carRect.right < oilRect.left ||
               carRect.left > oilRect.right ||
               carRect.bottom < oilRect.top ||
               carRect.top > oilRect.bottom);
    }

    // é–‹å§‹æ²¹æ¡¶æ‰è½
  function startOilFall(oil, word) {
    let y = parseFloat(oil.style.top); // å–å¾—åˆå§‹ä½ç½®
    const fall = setInterval(() => {
        if (!isPlaying) {
            clearInterval(fall);
            return;
        }

        y += oilDropSpeed;
        oil.style.top = y + 'px';

        if (checkCollision(car, oil)) {
            clearInterval(fall);
            if (word.ch === currentWord.ch) {
                energy = Math.min(5, energy + 1);
                score += 10;
                updateScore();
                showResultMsg('ç­”å° âœ…', 'green');
                speakText(word.en);

                // ç­”å°å¾Œï¼Œç«‹åˆ»ç§»é™¤æ‰€æœ‰æ²¹æ¡¶ä¸¦ç”¢ç”Ÿæ–°é¡Œç›®
                oils.forEach(o => {
                    if (o.parentNode) game.removeChild(o);
                });
                oils = [];
                nextQuestion();
                createOils(); // ç”¢ç”Ÿæ–°çš„æ²¹æ¡¶çµ„

            } else {
                energy = Math.max(0, energy - 1);
                oil.style.opacity = 0;
                showResultMsg('ç­”éŒ¯ âŒ', 'red');
            }
            updateEnergy();
            setTimeout(() => {
                if (oil.parentNode) game.removeChild(oil);
                oils = oils.filter(o => o !== oil);
            }, 1000);
            return;
        }

        if (y > 844) {
            clearInterval(fall);
            if (oil.parentNode) game.removeChild(oil);
            oils = oils.filter(o => o !== oil);
        }
    }, 20); // æ›´å¿«çš„æ›´æ–°é »ç‡
}
    // ç”¢ç”Ÿæ²¹æ¡¶
   function createOils() {
  if (oils.length >= 4) return;

  const numOilsToCreate = Math.min(4 - oils.length, 4);
  if (numOilsToCreate <= 0) return;

  const correctIndex = Math.floor(Math.random() * numOilsToCreate);
  const usedWords = new Set();
  usedWords.add(currentWord.ch);

  // æš«å­˜è¦ç”¢ç”Ÿçš„æ²¹æ¡¶
  const pendingOils = [];

  for (let i = 0; i < numOilsToCreate; i++) {
    let word;
    if (i === correctIndex) {
      word = currentWord;
    } else {
      do {
        word = wordList[Math.floor(Math.random() * wordList.length)];
      } while (usedWords.has(word.ch));
      usedWords.add(word.ch);
    }

    pendingOils.push({ word }); // æš«å­˜å–®å­—ï¼Œä¹‹å¾Œå†è¨ˆç®—ä½ç½®
  }

  let pairIndex = 0;

 function createOilPair() {
        if (!isPlaying || pairIndex >= 2) return; // æœ€å¤šå…©çµ„

        // å›ºå®šåœ¨å·¦å´
        const baseLeft1 = Math.random() * 0 + 40;
        const baseLeft2 = Math.random() * 100 + 250; // åœ¨å·¦å´ç¯„åœå…§

        // é™åˆ¶åº§æ¨™åœ¨åˆç†ç¯„åœå…§
        const left1 = Math.max(0, Math.min(80, baseLeft1));
        const left2 = Math.max(100, Math.min(350, baseLeft2));

        const startY = Math.max(0, -50 - Math.random() * 200);

        const oilData1 = pendingOils[pairIndex * 2];
        const oilData2 = (pairIndex * 2 + 1) < pendingOils.length ? pendingOils[pairIndex * 2 + 1] : null;

        // å»ºç«‹ç¬¬ä¸€å€‹æ²¹æ¡¶
        const oil1 = createSingleOil(oilData1.word, left1, startY);
        if (oil1) oils.push(oil1); // å¦‚æœæˆåŠŸå»ºç«‹å°±åŠ å…¥é™£åˆ—

        // å»ºç«‹ç¬¬äºŒå€‹æ²¹æ¡¶ (å¦‚æœæœ‰çš„è©±)
        if (oilData2) {
            const oil2 = createSingleOil(oilData2.word, left2, startY);
            if (oil2) oils.push(oil2);
        }

        pairIndex++; // ä¸‹ä¸€çµ„æ²¹æ¡¶
    }

  // æ¯ 1 ç§’å»ºç«‹ä¸€çµ„æ²¹æ¡¶
  const oilPairTimer = setInterval(() => {
    createOilPair();
    if (pairIndex >= 2) clearInterval(oilPairTimer); // å»ºç«‹å®Œå…©çµ„å°±åœæ­¢è¨ˆæ™‚å™¨
  }, 3000);

  // å»ºç«‹å–®ä¸€æ²¹æ¡¶çš„å‡½å¼
  function createSingleOil(word, left, startY) {
    const oil = document.createElement('div');
    oil.className = 'oil';
    oil.innerHTML = `ğŸ›¢ï¸<br>${word.en}`;
    oil.dataset.ch = word.ch;
    oil.dataset.en = word.en;
    oil.style.left = left + 'px';
    oil.style.top = startY + 'px';
    game.appendChild(oil);
    startOilFall(oil, word);
    return oil;
  }
}

    // èªéŸ³ç™¼éŸ³
    function speakText(text) {
      if (!('speechSynthesis' in window)) return;

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    }

    // å¢åŠ é›£åº¦
    function increaseDifficulty() {
      oilDropInterval = Math.max(1000, oilDropInterval - 100); // ç¸®çŸ­ç”Ÿæˆé–“éš”
      oilDropSpeed = Math.min(15, oilDropSpeed + 0.5); // æé«˜æ‰è½é€Ÿåº¦ï¼Œä½†æœ‰ä¸Šé™
      console.log("Difficulty increased: interval=", oilDropInterval, " speed=", oilDropSpeed);
      clearInterval(oilTimer);
      oilTimer = setInterval(createOils, oilDropInterval); // æ›´æ–°æ²¹æ¡¶ç”Ÿæˆè¨ˆæ™‚å™¨
    }

    // é–‹å§‹éŠæˆ²
    function startGame() {
      if (isPlaying) return;
      isPlaying = true;
      energy = 5;
      score = 0;
      updateScore();
      updateEnergy();
      nextQuestion();
      document.getElementById('startBtn').disabled = true; // ç¦ç”¨é–‹å§‹æŒ‰éˆ•
      gameOverScreen.style.display = 'none'; // éš±è—éŠæˆ²çµæŸç•«é¢

      carX = 160;
      carY = 600;
      car.style.left = carX + 'px';
      car.style.top = carY + 'px';

      oilDropInterval = 3000; // é‡ç½®ç”Ÿæˆé–“éš”
      oilDropSpeed = 4; // é‡ç½®æ‰è½é€Ÿåº¦

      oils.forEach(o => o.remove()); // ç§»é™¤èˆŠæ²¹æ¡¶
      oils = [];

      // é–‹å§‹è¨ˆæ™‚å™¨
      oilTimer = setInterval(createOils, oilDropInterval);
      energyTimer = setInterval(() => {
        energy--;
        updateEnergy();
      }, 10000);
      difficultyTimer = setInterval(increaseDifficulty, 15000); // æ¯ 15 ç§’å¢åŠ é›£åº¦
    }

    // çµæŸéŠæˆ²
    function endGame() {
      isPlaying = false;
      clearInterval(oilTimer);
      clearInterval(energyTimer);
      clearInterval(difficultyTimer);
      document.getElementById('startBtn').disabled = false; // å•Ÿç”¨é–‹å§‹æŒ‰éˆ•
      oils.forEach(o => o.remove());
      oils = [];

      // é¡¯ç¤ºéŠæˆ²çµæŸç•«é¢
      finalScoreEl.textContent = `ä½ çš„åˆ†æ•¸ï¼š${score}`;
      gameOverScreen.style.display = 'flex';
    }

    // è™›æ“¬æ–æ¡¿æ§åˆ¶
    const joystick = nipplejs.create({
      zone: document.getElementById('joystickZone'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: 'hotpink'
    });

    joystick.on('move', (evt, data) => {
      if (!isPlaying) return;

      if (data.direction) {
        // å–å¾—æ–¹å‘å‘é‡
        let dx = data.vector.x;
        let dy = data.vector.y;

        // ç§»å‹•é€Ÿåº¦å€ç‡
        const speed = 8;

        carX += dx * speed;
        carY -= dy * speed; // ä¿®æ­£é¡›å€’å•é¡Œ

        // é‚Šç•Œé™åˆ¶
        carX = Math.max(0, Math.min(320, carX));
        carY = Math.max(0, Math.min(700, carY));

        car.style.left = carX + 'px';
        car.style.top = carY + 'px';
      }
    });
  </script>
</body>
</html>